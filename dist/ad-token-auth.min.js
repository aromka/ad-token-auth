!function(t){"use strict";t.module("adTokenAuth",[]).provider("$auth",function(){var e={apiUrl:"/api",signOutUrl:"/auth/logout",emailSignInPath:"/auth/login",tokenValidationPath:"/auth/validate",tokenRefreshPath:"/auth/refresh",validateOnPageLoad:!0,tokenFormat:{Authorization:"Bearer {{ token }}"}},n={_storage:{},setItem:function(t,e){try{window.localStorage.setItem(t,e)}catch(n){this._storage[t]=e}},getItem:function(t){var e;try{e=window.localStorage.getItem(t)}catch(n){e=this._storage[t]}return e},removeItem:function(t){try{window.localStorage.removeItem(t)}catch(e){delete this._storage[t]}}};return{config:function(n){e=t.extend(e,n||{})},$get:["$http","$q","$location","$window","$timeout","$rootScope","$interpolate",function(i,r,a,o,s,u,h){return{header:null,d:null,isLoggedIn:!1,signIn:function(t){this.dInit();var e=this;return i.post(this.config().apiUrl+this.config().emailSignInPath,t).then(function(t){u.$broadcast("auth:success","login",t.data),e.handleValidAuth(t.data,!0),e.dResolve()})["catch"](function(t){u.$broadcast("auth:error","login",t),e.dReject({reason:"unauthorized",errors:["Invalid credentials"]})}),this.d.promise},userIsAuthenticated:function(){return this.retrieveData("auth_headers")&&this.isLoggedIn},validateUser:function(){return this.d?this.d.promise:(this.dInit(),this.userIsAuthenticated()?this.dResolve():this.isEmpty(this.retrieveData("auth_headers"))?(this.dReject({reason:"unauthorized",errors:["No credentials"]}),u.$broadcast("auth:invalid")):this.validateToken(),this.d.promise)},validateToken:function(){var t=this;return i.post(this.config().apiUrl+this.config().tokenValidationPath,{}).then(function(e){u.$broadcast("auth:success","validation",e.data),t.handleValidAuth(e.data),t.dResolve()})["catch"](function(e){return u.$broadcast("auth:error","validation",e),t.dReject({reason:"unauthorized",errors:e&&e.errors})})},invalidateTokens:function(){this.isLoggedIn=!1,this.deleteData("auth_headers")},signOut:function(){var t=this;return i["delete"](this.config().apiUrl+this.config().signOutUrl).then(function(){u.$broadcast("auth:logout-success")})["catch"](function(t){u.$broadcast("auth:logout-error",t)})["finally"](function(){t.invalidateTokens()})},handleValidAuth:function(t,e){this.isLoggedIn=!0,e&&this.setAuthHeaders(this.buildHeaders({token:t.token}))},buildHeaders:function(t){var e,n,i={},r=this.config().tokenFormat;for(e in r)n=r[e],i[e]=h(n)(t);return i},setAuthHeaders:function(e){var n=t.extend(this.retrieveData("auth_headers")||{},e);return this.persistData("auth_headers",n)},getAuthHeaders:function(){return this.retrieveData("auth_headers")},persistData:function(t,e){return n.setItem(t,JSON.stringify(e))},retrieveData:function(t){var e=n.getItem(t);if(e)try{return JSON.parse(e)}catch(i){}return null},deleteData:function(t){return n.removeItem(t)},dInit:function(){return this.d=r.defer(),this.d},dResolve:function(){null!=this.d&&(this.d.resolve(this.user),this.dReset())},dReject:function(t){this.invalidateTokens(),null!=this.d&&(this.d.reject(t),this.dReset())},dReset:function(){var t=this;s(function(){t.d=null})},config:function(){return e},isEmpty:function(t){var e,n;if(!t||0===t.length)return!0;if(t.length>0)return!1;for(e in t)if(n=t[e],Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}}}]}}).config(["$httpProvider",function(t){t.interceptors.push(["$injector","$q",function(t,e){var n=function(){t.invoke(["$rootScope","$auth",function(t,e){e.invalidateTokens(),t.$broadcast("auth:error")}])};return{request:function(e){return t.invoke(["$http","$auth",function(t,n){var i,r,a,o;if(e.url.match(n.config().apiUrl)){a=n.retrieveData("auth_headers"),o=[];for(i in a)r=a[i],o.push(e.headers[i]=r);return o}}]),e},responseError:function(i){var r=t.get("$auth");if(401===i.status&&-1===i.config.url.indexOf(r.config().emailSignInPath)){if(i.data&&"token_expired"===i.data[0]&&-1===i.config.url.indexOf(r.config().tokenRefreshPath)){var a=e.defer();return t.invoke(["$http","$auth",function(e,n){var r=n.retrieveData("auth_headers"),o=n.config().apiUrl+n.config().tokenRefreshPath;n.isEmpty(r)&&a.reject(i),e.post(o).then(function(e){n.handleValidAuth(e.data,!0);var r=t.get("$http");return r(i.config)}).then(function(t){a.resolve(t)})["catch"](function(t){a.reject(t)})}]),a.promise}n()}return e.reject(i)}}}])}]).run(["$auth",function(t){t.config().validateOnPageLoad&&t.validateUser()}])}(angular);